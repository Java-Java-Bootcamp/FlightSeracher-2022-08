<?xml version="1.0" encoding="UTF-8" ?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <changeSet id="init_db" author="khasmamedov">
        <createTable tableName="_user">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints unique="true" nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="varchar(255)">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="user_role">
            <column name="_user_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="user_role" baseColumnNames="_user_id"
                                 constraintName="_user_role_user_id"
                                 referencedTableName="_user" referencedColumnNames="id"/>

        <createTable tableName="account">
            <column name="account_id" type="SERIAL" autoIncrement="true">
                <constraints unique="true" nullable="false" primaryKey="true"/>
            </column>
            <column name="min_quantity" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="money_left" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_account__user" references="_user(id)"/>
            </column>
            <column name="account_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="transaction">
            <column name="transaction_id" type="SERIAL" autoIncrement="true">
                <constraints unique="true" nullable="false" primaryKey="true"/>
            </column>
            <column name="from_account_id" type="bigint">
                <constraints nullable="true" foreignKeyName="fk_transaction_account" references="account(account_id)"/>
            </column>
            <column name="to_account_id" type="bigint">
                <constraints nullable="true" foreignKeyName="fk_transaction_account_2"
                             references="account(account_id)"/>
            </column>
            <column name="data_and_time" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="sum" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="transaction_category">
            <column name="category_id" type="SERIAL" autoIncrement="true">
                <constraints unique="true" nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_transaction_category__user" references="_user(id)"/>
            </column>
        </createTable>
        <createTable tableName="transaction_to_category">
            <column name="transaction_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_transaction_to_category_transaction"
                             references="transaction(transaction_id)"/>
            </column>
            <column name="category_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="fk_transaction_to_category_transaction_category"
                             references="transaction_category(category_id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_data" author="khasmamedov">
        <insert tableName="_user">
            <column name="name">mikhail</column>
            <column name="password">
                $2y$10$unTgoaCIqak2SAaDygA3rOCRrsaxCKGSS.dge8VdM2AHEXApC5cgK</column>
            <column name="email">maksaimer@gmail.com</column>
        </insert>
        <insert tableName="_user">
            <column name="name">test</column>
            <column name="password">202cb962ac59075b964b07152d234b70</column>
            <column name="email">test@gmail.com</column>
        </insert>

        <insert tableName="user_role">
            <column name="_user_id">1</column>
            <column name="role">USER</column>
        </insert>

        <insert tableName="account">
            <column name="min_quantity">1000</column>
            <column name="money_left">90000</column>
            <column name="user_id">1</column>
            <column name="account_type">SBER</column>
        </insert>
        <insert tableName="account">
            <column name="min_quantity">100</column>
            <column name="money_left">50000</column>
            <column name="user_id">1</column>
            <column name="account_type">RSB</column>
        </insert>
        <insert tableName="account">
            <column name="min_quantity">0</column>
            <column name="money_left">90000</column>
            <column name="user_id">1</column>
            <column name="account_type">ALFA</column>
        </insert>
        <insert tableName="transaction_category">
            <column name="name">food</column>
            <column name="user_id">1</column>
        </insert>
        <insert tableName="transaction_category">
            <column name="name">clothes</column>
            <column name="user_id">1</column>
        </insert>
        <insert tableName="transaction_category">
            <column name="name">public utilities</column>
            <column name="user_id">1</column>
        </insert>
        <insert tableName="transaction">
            <column name="from_account_id">1</column>
            <column name="to_account_id">2</column>
            <column name="data_and_time">2014-01-01 20:00:00</column>
            <column name="sum">100</column>
        </insert>
        <insert tableName="transaction">
            <column name="from_account_id">1</column>
            <column name="to_account_id">3</column>
            <column name="data_and_time">2022-01-03 00:00:00</column>
            <column name="sum">200</column>
        </insert>
        <insert tableName="transaction">
            <column name="from_account_id">3</column>
            <column name="to_account_id">2</column>
            <column name="data_and_time">2021-01-03 00:00:00</column>
            <column name="sum">400</column>
        </insert>
        <insert tableName="transaction_to_category">
            <column name="transaction_id">1</column>
            <column name="category_id">2</column>
        </insert>
        <insert tableName="transaction_to_category">
            <column name="transaction_id">1</column>
            <column name="category_id">3</column>
        </insert>
        <insert tableName="transaction_to_category">
            <column name="transaction_id">3</column>
            <column name="category_id">1</column>
        </insert>
        <insert tableName="transaction_to_category">
            <column name="transaction_id">2</column>
            <column name="category_id">2</column>
        </insert>

    </changeSet>
</databaseChangeLog>
